#!/usr/bin/env bash

# This file is part of the Spectrum +4 Project.
# Licencing information can be found in the LICENCE file
# (C) 2021 Spectrum +4 Authors. All rights reserved.

function header {
  echo '# This file is part of the Spectrum +4 Project.'
  echo '# Licencing information can be found in the LICENCE file'
  echo '# (C) 2021 Spectrum +4 Authors. All rights reserved.'
  echo ''
  echo "# This file is auto-generated by ${0##*/}." 'DO NOT EDIT!'
  echo ''
  echo '.text'
}

cd "$(dirname "${0}")"

{
  header
  for ((c=1; c<34; c++)); do
    hexc=$(printf "%02x" $c)
    hl=$((0x5b00 + 33-c))
    hexhl=$(printf "%04x" $hl)
    x=$((33-c))
    hexx=$(printf "%02x" $x)
    echo
    echo
    echo "cl_set_printer_${hexc}_setup:"
    echo "  _setbit 1, FLAGS"
    echo "  ret"
    echo
    echo "cl_set_printer_${hexc}_setup_regs:"
    echo "  ld      c, 0x${hexc}"
    echo "  ret"
    echo
    echo "cl_set_printer_${hexc}_effects:"
    echo "  _strb   0x${hexc}, P_POSN_X"
    echo "  _strh   0x${hexhl}, PR_CC"
    echo "  ret"
    echo
    echo "cl_set_printer_${hexc}_effects_regs:"
    echo "  ld      a, 0x${hexx}"
    echo "  ld      de, 0x${hexx}"
    echo "  ld      hl, 0x${hexhl}"
    echo "  ldf     H_FLAG|X3_FLAG"
    echo "  ret"
  done
} > "test_cl_set.printer.s"

{
  header
  for ((c=1; c<34; c+=2)); do
    hexc=$(printf "%02x" $c)
    x=$((33-c))
    hexx=$(printf "%02x" $x)
    for b in 1 2 12 24; do
      y=$((24-b))
      screenthird=$((y/8))
      yoffset=$((y-8*screenthird))
      hexb=$(printf "%02x" $b)
      hl=$((0x4000 + x + screenthird*0x800 +32*yoffset))
      hexhl=$(printf "%04x" $hl)
      echo
      echo
      echo "cl_set_upper_screen_${hexc}_${hexb}_setup:"
      echo "  _resbit 1, FLAGS"
      echo "  _resbit 0, TV_FLAG"
      echo "  ret"
      echo
      echo "cl_set_upper_screen_${hexc}_${hexb}_setup_regs:"
      echo "  ld      bc, 0x${hexb}${hexc}"
      echo "  ret"
      echo
      echo "cl_set_upper_screen_${hexc}_${hexb}_effects:"
      echo "  _strh   0x${hexb}${hexc}, S_POSN_X"
      echo "  _strh   0x${hexhl}, DF_CC"
      echo "  ret"
      echo
      echo "cl_set_upper_screen_${hexc}_${hexb}_effects_regs:"
      echo "  ld      a, 0x${hexx}"
      echo "  ld      de, 0x${hexx}"
      echo "  ld      hl, 0x${hexhl}"
      echo "  ldf     H_FLAG|X3_FLAG|PV_FLAG|Z_FLAG"
      echo "  ret"
    done
  done
} > "test_cl_set.upperscreen.s"


{
  header
  for c in 1 5 13 23 31 32 33; do
    hexc=$(printf "%02x" $c)
    x=$((33-c))
    hexx=$(printf "%02x" $x)
    for df_sz in 1 12 19 24; do
      hexdfsz=$(printf "%02x" $df_sz)
      for ((b=25-df_sz; b<25; b+=3)); do
        y=$((48-b-df_sz))
        screenthird=$((y/8))
        yoffset=$((y-8*screenthird))
        hexb=$(printf "%02x" $b)
        hl=$((0x4000 + x + screenthird*0x800 +32*yoffset))
        hexhl=$(printf "%04x" $hl)
        echo
        echo
        echo "cl_set_lower_screen_${hexc}_${hexb}_${hexdfsz}_setup:"
        echo "  _resbit 1, FLAGS"
        echo "  _setbit 0, TV_FLAG"
        echo "  _strb   0x${hexdfsz}, DF_SZ"
        echo "  ret"
        echo
        echo "cl_set_lower_screen_${hexc}_${hexb}_${hexdfsz}_setup_regs:"
        echo "  ld      bc, 0x${hexb}${hexc}"
        echo "  ret"
        echo
        echo "cl_set_lower_screen_${hexc}_${hexb}_${hexdfsz}_effects:"
        echo "  _strh   0x${hexb}${hexc}, S_POSN_X_L"
        echo "  _strh   0x${hexb}${hexc}, ECHO_E_X"
        echo "  _strh   0x${hexhl}, DF_CC_L"
        echo "  ret"
        echo
        echo "cl_set_lower_screen_${hexc}_${hexb}_${hexdfsz}_effects_regs:"
        echo "  ld      a, 0x${hexx}"
        echo "  ld      de, 0x${hexx}"
        echo "  ld      hl, 0x${hexhl}"
        echo "  ldf     H_FLAG|X3_FLAG"
        echo "  ret"
      done
    done
  done
} > "test_cl_set.lowerscreen.s"
