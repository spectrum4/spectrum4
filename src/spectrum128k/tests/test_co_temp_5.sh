#!/usr/bin/env bash

# This file is part of the Spectrum +4 Project.
# Licencing information can be found in the LICENCE file
# (C) 2021 Spectrum +4 Authors. All rights reserved.

set -eu
set -o pipefail
export SHELLOPTS

cd "$(dirname "${0}")"

# This initial state data was generated randomly, except for registers A and D.
# A is consistently assigned the value 0x13 (control character "BRIGHT"), and D
# has a random value of either 0x00 or 0x01 or 0x08 (BRIGHT 0/1/8
# respectively).
#
# The end state fields were reverse engineered by running the tests first with
# incorrect values, and then scraping the test failure logs to get the correct
# values, and then plugging them back into this input data, in place of the
# arbitrary values.
#
# This was done in order to have a set of test data for the Spectrum +4
# co_temp_5 routine, taking a random set of input values for (ATTR_T, P_FLAG,
# MASK_T, and register F) and determining the values that the registers and
# system variables are updated to on the Spectrum 128K, to make sure the
# Spectrum +4 routine updates the system variables consistently with the
# Spectrum 128K, under the same conditions.

input='0x02 0x05 0x1d 0x13 0x00 0x41 0x02 0x05 0x1d 0x40 0x04 0x40 0x00 0x5c 0x91
0xb9 0x9e 0x5a 0x13 0x00 0x39 0xb9 0x9e 0x5a 0x40 0x88 0x40 0x00 0x5c 0x91
0x20 0x7e 0xc1 0x13 0x00 0x71 0x20 0x3e 0xc1 0x40 0x28 0x40 0x00 0x5c 0x91
0xe0 0x75 0xf5 0x13 0x00 0xd8 0xa0 0x35 0xf5 0x40 0x24 0x40 0x00 0x5c 0x91
0xbd 0xaf 0x8f 0x13 0x01 0xf9 0xfd 0xaf 0x8f 0x40 0xac 0x40 0x40 0x5c 0x91
0x40 0xf9 0x82 0x13 0x01 0xbd 0x40 0xb9 0x82 0x40 0xa8 0x40 0x40 0x5c 0x91
0x12 0x36 0xf7 0x13 0x00 0x60 0x12 0x36 0xf7 0x40 0x24 0x40 0x00 0x5c 0x91
0xd1 0xb9 0xee 0x13 0x08 0x9f 0x91 0xf9 0xee 0x40 0xac 0x40 0x02 0x5c 0x91
0x40 0x2a 0xf1 0x13 0x01 0xcc 0x40 0x2a 0xf1 0x40 0x28 0x40 0x40 0x5c 0x91
0x8e 0x57 0xeb 0x13 0x01 0xad 0xce 0x17 0xeb 0x40 0x04 0x40 0x40 0x5c 0x91
0xc6 0x2e 0x6e 0x13 0x08 0xd4 0x86 0x6e 0x6e 0x40 0x28 0x40 0x02 0x5c 0x91
0x63 0xd3 0x01 0x13 0x08 0xd6 0x23 0xd3 0x01 0x40 0x80 0x40 0x02 0x5c 0x91
0x7d 0xaa 0x0e 0x13 0x00 0x89 0x3d 0xaa 0x0e 0x40 0xac 0x40 0x00 0x5c 0x91
0x47 0x76 0x5c 0x13 0x08 0xe5 0x07 0x76 0x5c 0x40 0x20 0x40 0x02 0x5c 0x91
0xdb 0x44 0xdd 0x13 0x08 0x86 0x9b 0x44 0xdd 0x40 0x04 0x40 0x02 0x5c 0x91
0x37 0x94 0xb3 0x13 0x08 0x9b 0x37 0xd4 0xb3 0x40 0x84 0x40 0x02 0x5c 0x91
0x15 0x86 0x6b 0x13 0x00 0x34 0x15 0x86 0x6b 0x40 0x80 0x40 0x00 0x5c 0x91
0x64 0x71 0x49 0x13 0x00 0x85 0x24 0x31 0x49 0x40 0x20 0x40 0x00 0x5c 0x91
0x8c 0xb9 0xe5 0x13 0x00 0x2e 0x8c 0xb9 0xe5 0x40 0xa8 0x40 0x00 0x5c 0x91
0x79 0xb5 0x71 0x13 0x08 0xc3 0x39 0xf5 0x71 0x40 0xa4 0x40 0x02 0x5c 0x91
0xe5 0xa0 0x80 0x13 0x00 0x5a 0xa5 0xa0 0x80 0x40 0xa4 0x40 0x00 0x5c 0x91
0xb6 0x52 0x24 0x13 0x01 0xe7 0xf6 0x12 0x24 0x40 0x04 0x40 0x40 0x5c 0x91
0x54 0x59 0xb1 0x13 0x01 0x67 0x54 0x19 0xb1 0x40 0x08 0x40 0x40 0x5c 0x91
0x35 0xb4 0x0d 0x13 0x00 0xbd 0x35 0xb4 0x0d 0x40 0xa4 0x40 0x00 0x5c 0x91
0xc7 0xb5 0xd7 0x13 0x01 0x9c 0xc7 0xb5 0xd7 0x40 0xa0 0x40 0x40 0x5c 0x91
0xdb 0xa0 0xb4 0x13 0x01 0xbc 0xdb 0xa0 0xb4 0x40 0xa4 0x40 0x40 0x5c 0x91
0x3f 0x54 0x0d 0x13 0x08 0x7d 0x3f 0x54 0x0d 0x40 0x00 0x40 0x02 0x5c 0x91
0xfc 0x4b 0xc4 0x13 0x00 0x5b 0xbc 0x0b 0xc4 0x40 0x08 0x40 0x00 0x5c 0x91
0x65 0x96 0xad 0x13 0x08 0x3d 0x25 0xd6 0xad 0x40 0x80 0x40 0x02 0x5c 0x91
0xcb 0x4d 0x01 0x13 0x08 0xa9 0x8b 0x4d 0x01 0x40 0x0c 0x40 0x02 0x5c 0x91
0x21 0xa0 0x27 0x13 0x08 0x38 0x21 0xe0 0x27 0x40 0xa0 0x40 0x02 0x5c 0x91
0x06 0xbe 0x9c 0x13 0x00 0x3a 0x06 0xbe 0x9c 0x40 0xac 0x40 0x00 0x5c 0x91
0x9f 0x91 0x71 0x13 0x00 0x02 0x9f 0x91 0x71 0x40 0x80 0x40 0x00 0x5c 0x91
0xc9 0xfc 0xe7 0x13 0x01 0x92 0xc9 0xbc 0xe7 0x40 0xa8 0x40 0x40 0x5c 0x91
0x9e 0xbd 0xec 0x13 0x01 0x50 0xde 0xbd 0xec 0x40 0xac 0x40 0x40 0x5c 0x91
0xf0 0x10 0x15 0x13 0x01 0x0e 0xf0 0x10 0x15 0x40 0x00 0x40 0x40 0x5c 0x91
0xcc 0x93 0xbb 0x13 0x08 0x3e 0x8c 0xd3 0xbb 0x40 0x80 0x40 0x02 0x5c 0x91
0x99 0x00 0xf1 0x13 0x01 0x25 0xd9 0x00 0xf1 0x40 0x44 0x40 0x40 0x5c 0x91
0xe9 0x10 0x1f 0x13 0x08 0x8f 0xa9 0x50 0x1f 0x40 0x04 0x40 0x02 0x5c 0x91
0x6f 0x13 0x8e 0x13 0x08 0x41 0x2f 0x53 0x8e 0x40 0x04 0x40 0x02 0x5c 0x91
0x51 0xa9 0x32 0x13 0x08 0x5b 0x11 0xe9 0x32 0x40 0xa8 0x40 0x02 0x5c 0x91
0x9b 0x44 0x1f 0x13 0x00 0x27 0x9b 0x04 0x1f 0x40 0x00 0x40 0x00 0x5c 0x91
0xe5 0xe2 0x31 0x13 0x00 0x60 0xa5 0xa2 0x31 0x40 0xa0 0x40 0x00 0x5c 0x91
0xbb 0xd3 0x42 0x13 0x08 0x5b 0xbb 0xd3 0x42 0x40 0x80 0x40 0x02 0x5c 0x91
0x01 0x03 0x82 0x13 0x01 0xf7 0x41 0x03 0x82 0x40 0x04 0x40 0x40 0x5c 0x91
0x89 0x0b 0x25 0x13 0x00 0x2f 0x89 0x0b 0x25 0x40 0x08 0x40 0x00 0x5c 0x91
0x76 0x91 0xa0 0x13 0x01 0x41 0x76 0x91 0xa0 0x40 0x80 0x40 0x40 0x5c 0x91
0x80 0x5b 0xb4 0x13 0x00 0xcf 0x80 0x1b 0xb4 0x40 0x0c 0x40 0x00 0x5c 0x91
0x86 0xe0 0x20 0x13 0x00 0x16 0x86 0xa0 0x20 0x40 0xa4 0x40 0x00 0x5c 0x91
0x01 0x8f 0x8b 0x13 0x00 0xd7 0x01 0x8f 0x8b 0x40 0x88 0x40 0x00 0x5c 0x91
0xd3 0x83 0xd3 0x13 0x01 0xfe 0xd3 0x83 0xd3 0x40 0x80 0x40 0x40 0x5c 0x91
0xa4 0xfd 0x7b 0x13 0x01 0x6b 0xe4 0xbd 0x7b 0x40 0xac 0x40 0x40 0x5c 0x91
0x48 0x32 0x96 0x13 0x08 0xd9 0x08 0x72 0x96 0x40 0x24 0x40 0x02 0x5c 0x91
0x2b 0xef 0xe1 0x13 0x08 0x7d 0x2b 0xef 0xe1 0x40 0xa8 0x40 0x02 0x5c 0x91
0xc1 0x7d 0x8b 0x13 0x08 0xe0 0x81 0x7d 0x8b 0x40 0x2c 0x40 0x02 0x5c 0x91
0xec 0x83 0x50 0x13 0x00 0xf6 0xac 0x83 0x50 0x40 0x80 0x40 0x00 0x5c 0x91
0x6f 0x0d 0xd6 0x13 0x01 0x81 0x6f 0x0d 0xd6 0x40 0x08 0x40 0x40 0x5c 0x91
0x80 0xc2 0x54 0x13 0x00 0x01 0x80 0x82 0x54 0x40 0x84 0x40 0x00 0x5c 0x91
0xb6 0xd5 0xf8 0x13 0x08 0xd8 0xb6 0xd5 0xf8 0x40 0x80 0x40 0x02 0x5c 0x91
0x2f 0xf6 0x8c 0x13 0x01 0x5c 0x6f 0xb6 0x8c 0x40 0xa0 0x40 0x40 0x5c 0x91
0x02 0x19 0x4a 0x13 0x00 0x61 0x02 0x19 0x4a 0x40 0x08 0x40 0x00 0x5c 0x91
0x0a 0x0a 0x21 0x13 0x00 0x2a 0x0a 0x0a 0x21 0x40 0x0c 0x40 0x00 0x5c 0x91
0x22 0x60 0x2e 0x13 0x08 0xad 0x22 0x60 0x2e 0x40 0x24 0x40 0x02 0x5c 0x91
0x1c 0x2e 0x74 0x13 0x00 0xa9 0x1c 0x2e 0x74 0x40 0x2c 0x40 0x00 0x5c 0x91'
{

  echo '# This file is part of the Spectrum +4 Project.'
  echo '# Licencing information can be found in the LICENCE file'
  echo '# (C) 2021 Spectrum +4 Authors. All rights reserved.'
  echo
  echo "# This file is auto-generated by ${0##*/}." 'DO NOT EDIT!'
  echo
  echo
  echo '.text'

  i=0
  echo "${input}" | while read attr_t mask_t p_flag a d f attr_t_upd mask_t_upd p_flag_upd a_upd f_upd b_upd c_upd h_upd l_upd; do
    testname=$(printf "co_temp_5_%02x" $i)
    i=$((i + 1))

    echo
    echo
    echo "${testname}_setup:"
    echo "  _strb   ${attr_t}, ATTR_T"
    echo "  _strb   ${mask_t}, MASK_T"
    echo "  _strb   ${p_flag}, P_FLAG"
    echo "  ret"
    echo
    echo "${testname}_setup_regs:"
    echo "  ld      a, ${a}"
    echo "  ld      d, ${d}"
    echo "  ldf     ${f}"
    echo "  ret"
    echo
    echo "${testname}_effects:"
    echo "  _strb   ${attr_t_upd}, ATTR_T"
    echo "  _strb   ${mask_t_upd}, MASK_T"
    echo "  _strb   ${p_flag_upd}, P_FLAG"
    echo "  ret"
    echo
    echo "${testname}_effects_regs:"
    echo "  ld      a, ${a_upd}"
    echo "  ld      b, ${b_upd}"
    echo "  ld      c, ${c_upd}"
    echo "  ldf     ${f_upd}"
    echo "  ld      h, ${h_upd}"
    echo "  ld      l, ${l_upd}"
    echo "  ret"
  done
} | ../../../utils/asm-format/asm-format > "test_co_temp_5.gen-s"
