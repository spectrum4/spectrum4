#!/usr/bin/env bash

# This file is part of the Spectrum +4 Project.
# Licencing information can be found in the LICENCE file
# (C) 2021 Spectrum +4 Authors. All rights reserved.

set -eu
set -o pipefail
export SHELLOPTS

function test_po_mosaic_half {
  newb=$(((256*carry + b)>>2))

  b_bit0=$((b%2))
  b_bit1=$(((b>>1)%2))
  a=$((16*15*b_bit1 + 15*b_bit0))

  hexa=$(printf "0x%02x" $a)
  hexb=$(printf "0x%02x" $b)
  hexnewb=$(printf "0x%02x" $newb)

  testname="po_mosaic_half_${hexb}_${carry}"

  echo
  echo "${testname}_setup_regs:"
  echo "  ld      b, ${hexb}"
  echo "  ld      hl, 0x4000"
  echo "  scf"
  if [ "${carry}" -eq "0" ]; then
    echo "  ccf"
  fi
  echo '  ret'
  echo
  echo "${testname}_effects:"
  echo "  ld      l, ${hexa}"
  echo "  ld      h, l"
  echo "  ld      (0x4000), hl"
  echo "  ld      (0x4002), hl"
  echo '  ret'
  echo
  echo "${testname}_effects_regs:"
  echo "  ld      a, ${hexa}"
  echo "  ld      b, ${hexnewb}"
  echo "  ld      c, 0"
  echo "  ld      hl, 0x4004"
  echo "  ldf     Z_FLAG|N_FLAG"
  echo '  ret'
}


cd "$(dirname "${0}")"

for chunk in 0 1 2 3; do
  {
    echo '# This file is part of the Spectrum +4 Project.'
    echo '# Licencing information can be found in the LICENCE file'
    echo '# (C) 2021 Spectrum +4 Authors. All rights reserved.'
    echo
    echo "# This file is auto-generated by ${0##*/}." 'DO NOT EDIT!'
    echo
    echo
    echo '.text'
    for ((i=0; i<128; i++)); do
      b=$((i+128*(chunk%2)))
      carry=$((chunk>>1))
      test_po_mosaic_half
    done
  } | ../../../utils/asm-format/asm-format > "test_po_mosaic_half.${chunk}.gen-s"
done
