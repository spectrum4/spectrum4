#!/usr/bin/env bash

# This file is part of the Spectrum +4 Project.
# Licencing information can be found in the LICENCE file
# (C) 2021 Spectrum +4 Authors. All rights reserved.

set -eu
set -o pipefail
export SHELLOPTS

cd "$(dirname "${0}")"

OIFS="${IFS}"
IFS=""
for rom in 0 1; do
  {
    echo '# This file is part of the Spectrum +4 Project.'
    echo '# Licencing information can be found in the LICENCE file'
    echo '# (C) 2021 Spectrum +4 Authors. All rights reserved.'
    echo
    echo "# This file is auto-generated by ${0##*/}." 'DO NOT EDIT!'
    echo
    echo "# It is not assembled either, it is just a useful reference document that contains the entire ROM ${rom} code."
    echo "# To modify assembly in this file, find the original source file in the same directory that it is copied here from."
    echo
    cat "rom${rom}.s" | while read line; do
      include="$(echo "${line}" | sed -n 's/^[[:space:]]*\.include *"\(.*\)".*/\1/p')"
      if [ -n "${include}" ]; then
        echo
        echo
        echo "# FROM \"${include}\":"
        echo
        cat "${include}"
      else
        echo "${line}"
      fi
    done
  } > "rom${rom}_full.gen-s"
done
IFS="${OIFS}"
