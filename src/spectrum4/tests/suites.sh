#!/usr/bin/env bash

# This file is part of the Spectrum +4 Project.
# Licencing information can be found in the LICENCE file
# (C) 2021 Spectrum +4 Authors. All rights reserved.

set -eu
set -o pipefail
export SHELLOPTS

cd "$(dirname "${0}")"

function generate_test_suites {
  local ptrunit="${1}"
  local ptralignstr="${2}"
  shift 2
  local files=("${@}")
  local bashflags="${-}"
  set +x
  echo "# This file is part of the Spectrum +4 Project."
  echo "# Licencing information can be found in the LICENCE file"
  echo "# (C) 2021 Spectrum +4 Authors. All rights reserved."
  echo
  echo "# Extrapolated from ${files[@]}."
  echo
  echo "# This file is auto-generated by ${0##*/}." 'DO NOT EDIT!'
  echo
  echo
  echo ".include \"kernel.s\""
  echo
  echo ".if ROMS_INCLUDE"
  echo "  .include \"roms.s\""
  echo ".endif"
  echo
  echo ".if ROMS_INCLUDE"
  echo "  .include \"bss.s\""
  echo ".else"
  echo "  .if TESTS_INCLUDE"
  echo "    .include \"bss.s\""
  echo "  .endif"
  echo ".endif"
  echo
  echo ".if DEMO_INCLUDE"
  echo "  .include \"demo.s\""
  echo ".endif"
  echo
  echo ".if TESTS_INCLUDE"
  echo "  .include \"runtests.s\""
  echo "  .text"
  echo -n "  ${ptralignstr}"
  echo "  all_suites:"
  total=0
  for file in "${files[@]}"; do
    t="$(cat "${file}" | sed -n '1,/\.quad/s/^  .quad //p' | sed -n 1p)"
    total=$((total + t))
  done
  echo "    ${ptrunit} ${total}"
  for file in "${files[@]}"; do
    suite="$(echo "${file}" | sed -n 's/test_\(.*\)\.suite/suite_\1/p' | sed 's/\./_/g')"
    echo "    ${ptrunit} ${suite}"
  done
  for file in "${files[@]}"; do
    filename="${file##*/}"
    echo "  .include \"${filename}\""
  done
  echo ".endif"
  echo
  echo ".if TESTS_INCLUDE"
  echo "  .include \"libextra.s\""
  echo ".else"
  echo "  .if DEMO_INCLUDE"
  echo "    .include \"libextra.s\""
  echo "  .endif"
  echo ".endif"
  echo
  echo ".include \"mmu.s\""
  if [ "${bashflags/x/-}" != "${bashflags}" ]; then set -x; fi
}

generate_test_suites .quad ".align 3
" "${@}" | ../../../utils/asm-format/asm-format
