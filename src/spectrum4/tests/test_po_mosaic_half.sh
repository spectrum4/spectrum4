#!/usr/bin/env bash

# This file is part of the Spectrum +4 Project.
# Licencing information can be found in the LICENCE file
# (C) 2021 Spectrum +4 Authors. All rights reserved.

function test_po_mosaic_half {

  w3_bit0=$((w3%2))
  w3_bit1=$(((w3>>1)%2))
  z_flag=$((1-w3_bit1))
  w3_shifted=$((w3>>2))
  hexw3=$(printf "0x%02x" $w3)
  hexw3_shifted=$(printf "0x%02x" $w3_shifted)

  b0="00"
  if [ "${w3_bit0}" == "1" ]; then
    b0="ff"
  fi
  b1="00"
  if [ "${w3_bit1}" == "1" ]; then
    b1="ff"
  fi
  hexw4="${b1}${b0}${b1}${b0}${b1}${b0}${b1}${b0}"

  testname="po_mosaic_half_${hexw3}"

  echo
  echo "${testname}_setup_regs:"
  echo "  mov     w3, ${hexw3}"
  echo "  adr     x6, display_file"
  echo '  ret'
  echo
  echo "${testname}_effects:"
  echo "  _str    0x${b1}${b0}${b1}${b0}${b1}${b0}${b1}${b0}, display_file"
  echo "  _str    0x${b1}${b0}${b1}${b0}${b1}${b0}${b1}${b0}, display_file+8"
  echo '  ret'
  echo
  echo "${testname}_effects_regs:"
  echo "  mov     w3, #${hexw3_shifted}"
  echo "  mov     x4, #0x${b1}${b0}${b1}${b0}${b1}${b0}${b1}${b0}"
  echo "  mov     x5, #0x${b1}00${b1}00${b1}00${b1}00"
  echo "  adr     x6, display_file+0x10"
  echo "  nzcv    #0b0${z_flag}00"
  echo '  ret'
}


cd "$(dirname "${0}")"

{
  echo '# This file is part of the Spectrum +4 Project.'
  echo '# Licencing information can be found in the LICENCE file'
  echo '# (C) 2021 Spectrum +4 Authors. All rights reserved.'
  echo
  echo "# This file is auto-generated by ${0##*/}." 'DO NOT EDIT!'
  echo
  echo '.text'
  echo '.align 2'
  echo
  echo
  echo '.if ROMS_INCLUDE'
  echo '.else'
  echo '  .include "print_w0.s"'
  echo '.endif'
  for ((w3=0; w3<256; w3++)); do
    test_po_mosaic_half
  done
} | ../../../utils/asm-format/asm-format > "test_po_mosaic_half.gen-s"
