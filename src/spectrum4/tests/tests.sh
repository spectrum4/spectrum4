#!/usr/bin/env bash

# This file is part of the Spectrum +4 Project.
# Licencing information can be found in the LICENCE file
# (C) 2021 Spectrum +4 Authors. All rights reserved.

set -eu
set -o pipefail
export SHELLOPTS


cd "$(dirname "${0}")"


function generate_unit_tests {
  local ptrunit="${1}"
  local ptralignstr="${2}"
  shift 2
  local files=("${@}")
  local bashflags="${-}"
  set +x
  echo "# This file is part of the Spectrum +4 Project."
  echo "# Licencing information can be found in the LICENCE file"
  echo "# (C) 2021 Spectrum +4 Authors. All rights reserved."
  echo
  echo "# Extrapolated from ${files[@]}."
  echo
  echo "# This file is auto-generated by ${0##*/}." 'DO NOT EDIT!'
  echo
  echo
  for file in "${files[@]}"; do
    echo ".include \"${file##*/}\""
    routine="$(echo "${file}" | sed -n 's/test_\([^.]*\)\..*/\1/p')"
    echo ".if ROMS_INCLUDE"
    echo ".else"
    echo ".include \"${routine}.s\""
    echo ".endif"
  done
  echo
  echo
  echo ".text"
  all_suites=""
  if [ "${#files[@]}" -gt 0 ]; then
    all_labels="$(for file in "${files[@]}"; do cat "${file}"; done | sed -n 's/^[[:space:]]*\([^#[:space:]]*\):.*/\1/p')"
    all_suites="$({
      echo "${all_labels}" | sed -n 's/_setup$//p'
      echo "${all_labels}" | sed -n 's/_setup_regs$//p'
      echo "${all_labels}" | sed -n 's/_effects$//p'
      echo "${all_labels}" | sed -n 's/_effects_regs$//p'
    } | LC_ALL=C sort -u)"
  fi
  if [ -n "${all_suites}" ]; then
    for file in "${files[@]}"; do
      suite="$(echo "${file}" | sed -n 's/test_\(.*\)\..*/suite_\1/p' | sed 's/\./_/g')"
      routine="$(echo "${file}" | sed -n 's/test_\([^.]*\)\..*/\1/p')"
      labels="$(cat "${file}" | sed -n 's/^[[:space:]]*\([^#[:space:]]*\):.*/\1/p')"
      tests="$({
        echo "${labels}" | sed -n 's/_setup$//p'
        echo "${labels}" | sed -n 's/_setup_regs$//p'
        echo "${labels}" | sed -n 's/_effects$//p'
        echo "${labels}" | sed -n 's/_effects_regs$//p'
      } | LC_ALL=C sort -u)"
      echo
      echo
      echo -n "${ptralignstr}"
      echo "${suite}:"
      echo "  ${ptrunit}" $(echo "${tests}" | wc -l)
      echo "  ${ptrunit} ${routine}"
      echo "${tests}" | while read t; do
        echo "  ${ptrunit} test_${t}"
      done
      echo "${tests}" | while read t; do
        echo
        echo
        echo -n "${ptralignstr}"
        echo "test_${t}:"
        for suffix in _{setup,effects}{,_regs}; do
          if [ -n "$(echo "${labels}" | sed -n "s/^${t}${suffix}$/&/p")" ]; then
            echo "  ${ptrunit} ${t}${suffix}"
          else
            echo "  ${ptrunit} 0"
          fi
        done
        echo "  .asciz \"${t}\""
      done
    done
  else
    echo "  ${ptrunit} 0"
  fi
  if [ "${bashflags/x/-}" != "${bashflags}" ]; then set -x; fi
}

generate_unit_tests .quad ".align 3
" "${@}" | ../../../utils/asm-format/asm-format
